#!/usr/bin/env python3
"""
Madu Trigona Brief Enhancement Test
Tests the AI enhancement workflow specifically for the Madu Trigona honey product.
"""

import asyncio
import sys
import os
import json

# Add the current directory to Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from app.schemas.models import WizardInput
from app.services.brief_orchestrator import BriefOrchestratorService
from app.services.ai_client import AIClient


def create_madu_trigona_wizard_input():
    """Create comprehensive wizard input for Madu Trigona."""
    return WizardInput(
        user_request="Cinematic commercial of a honey product \"Madu Ahlan Trigona\". A natural rainforest background with sunlight rays shining through the trees, a waterfall in the distance, and glowing golden honeycombs floating around the bottle. Close-up of the honey bottle standing on a mossy rock, golden honey drops slowly dripping. Dynamic glowing particle effects emphasize freshness and health benefits. Camera smoothly rotates around the bottle with dramatic lighting and lens flare, highlighting the label text \"Alami dan Berkhasiat\". Transition into slow-motion honey pouring into a spoon with golden sparkles, then zoom out showing the product with tagline: \"Madu Ahlan Trigona ‚Äì Alami, Murni, dan Berkhasiat\". Elegant, high contrast, glossy, realistic 3D style, professional advertisement look.",
        
        product_name="Madu Ahlan Trigona",
        product_description="Premium natural honey from Trigona bees, sourced from pristine rainforests. Known for its pure, therapeutic properties and distinctive taste profile.",
        key_features="Natural rainforest honey, Trigona bee sourced, therapeutic benefits, pure and organic, traditional Indonesian honey with \"Alami dan Berkhasiat\" (Natural and Beneficial) properties",
        product_state="pristine",
        
        shot_type="Low-angle",
        framing="Close-Up",
        compositional_rule="Rule of Thirds",
        negative_space="Balanced",
        
        lighting_style="Natural golden hour with dramatic rim lighting",
        key_light_setup="Natural sunlight streaming through rainforest canopy at golden hour angle",
        fill_light_setup="Soft bounced light from waterfall mist and forest reflection",
        rim_light_setup="Strong natural rim light creating lens flare and bottle edge glow",
        mood="Mystical and luxurious with natural elegance",
        
        environment="Natural rainforest setting with waterfall backdrop",
        dominant_colors="Deep forest greens and rich golden amber tones",
        accent_colors="Warm golden honey amber, bright sunlight rays, crystal clear water blues",
        props="Mossy rock pedestal, floating golden honeycombs, honey droplets, wooden spoon, glowing particle effects",
        
        camera_type="RED Komodo 6K",
        lens_type="85mm f/1.4 Cine Prime",
        aperture_value=2.8,
        shutter_speed_value=50,
        iso_value=400,
        visual_effect="Smooth 360-degree camera rotation with dramatic lens flare, slow-motion honey pour, glowing particle VFX",
        
        overall_style="Cinematic commercial with realistic 3D rendering",
        photographer_influences="Peter Lindbergh's natural elegance meets Denis Villeneuve's cinematic atmosphere"
    )


async def test_madu_trigona_enhancement():
    """Test the complete enhancement workflow for Madu Trigona."""
    
    print("üçØ MADU TRIGONA BRIEF ENHANCEMENT TEST")
    print("=" * 70)
    
    # Create wizard input
    wizard_input = create_madu_trigona_wizard_input()
    print(f"üìã Product: {wizard_input.product_name}")
    print(f"üé¨ Style: {wizard_input.overall_style}")
    print(f"üì∏ Camera: {wizard_input.camera_type} with {wizard_input.lens_type}")
    print()
    
    # Initialize services
    orchestrator = BriefOrchestratorService()
    ai_client = AIClient()
    
    # Step 1: Generate Initial Brief (Template-Based)
    print("üìù STEP 1: Generating Initial Brief (Template-Based)")
    print("-" * 50)
    
    try:
        preview_data = await orchestrator.get_brief_preview(wizard_input)
        initial_brief = preview_data["initial_brief"]
        validation = preview_data["validation"]
        
        print(f"‚úÖ Initial brief generated: {len(initial_brief)} characters")
        print(f"‚úîÔ∏è  Validation status: {validation['is_valid']}")
        
        if validation.get("warnings"):
            print(f"‚ö†Ô∏è  Warnings: {len(validation['warnings'])}")
        
        # Save initial brief
        with open("madu_trigona_initial_brief.txt", "w", encoding="utf-8") as f:
            f.write("MADU TRIGONA - INITIAL PHOTOGRAPHY BRIEF\n")
            f.write("Generated by Template System\n")
            f.write("=" * 50 + "\n\n")
            f.write(initial_brief)
        
        print("üíæ Initial brief saved to: madu_trigona_initial_brief.txt")
        
        # Show preview
        print("\nüìñ Initial Brief Preview (first 200 chars):")
        print("-" * 50)
        print(initial_brief[:200] + "...")
        
    except Exception as e:
        print(f"‚ùå Initial brief generation failed: {e}")
        return
    
    # Step 2: Test AI Enhancement
    print("\n\nü§ñ STEP 2: Testing AI Enhancement")
    print("-" * 50)
    
    try:
        enhanced_brief = await ai_client.enhance_brief(initial_brief)
        
        print(f"‚úÖ AI Enhancement SUCCESS!")
        print(f"üìÑ Enhanced brief: {len(enhanced_brief)} characters")
        print(f"üìà Enhancement ratio: {len(enhanced_brief)/len(initial_brief):.1f}x")
        
        # Save enhanced brief
        with open("madu_trigona_enhanced_brief.txt", "w", encoding="utf-8") as f:
            f.write("MADU TRIGONA - AI ENHANCED PHOTOGRAPHY BRIEF\n")
            f.write("Generated by AI Creative Director\n")
            f.write("=" * 50 + "\n\n")
            f.write("ORIGINAL BRIEF:\n")
            f.write(initial_brief + "\n\n")
            f.write("=" * 50 + "\n")
            f.write("AI ENHANCED BRIEF:\n")
            f.write(enhanced_brief)
        
        print("üíæ Enhanced brief saved to: madu_trigona_enhanced_brief.txt")
        
        # Show comparison
        print("\nüìä ENHANCEMENT COMPARISON:")
        print(f"   Initial:  {len(initial_brief):,} characters")
        print(f"   Enhanced: {len(enhanced_brief):,} characters")
        print(f"   Improvement: +{len(enhanced_brief)-len(initial_brief):,} characters")
        
        print("\nüìñ Enhanced Brief Preview (first 200 chars):")
        print("-" * 50)
        print(enhanced_brief[:200] + "...")
        
    except Exception as e:
        print(f"‚ùå AI Enhancement FAILED: {str(e)}")
        print("\nüí° This is expected without a valid API key")
        print("   The initial brief is still professional and usable")
        
        # Create mock enhanced brief to show what it would look like
        mock_enhanced = create_mock_enhanced_brief(initial_brief)
        
        print(f"\nüé≠ MOCK ENHANCEMENT PREVIEW:")
        print("   (This shows what AI enhancement would produce)")
        print("-" * 50)
        
        with open("madu_trigona_mock_enhanced_brief.txt", "w", encoding="utf-8") as f:
            f.write("MADU TRIGONA - MOCK AI ENHANCED PHOTOGRAPHY BRIEF\n")
            f.write("Simulated AI Enhancement (for demonstration)\n")
            f.write("=" * 50 + "\n\n")
            f.write(mock_enhanced)
        
        print("üíæ Mock enhanced brief saved to: madu_trigona_mock_enhanced_brief.txt")
        print(f"üìÑ Mock enhanced length: {len(mock_enhanced)} characters")
    
    # Step 3: Full Workflow Test
    print("\n\nüîÑ STEP 3: Full Workflow Test")
    print("-" * 50)
    
    try:
        brief_output = await orchestrator.generate_final_brief(wizard_input)
        print("‚úÖ Full workflow completed with AI enhancement")
        print(f"üìÑ Final output: {len(brief_output.final_prompt)} characters")
        
    except Exception as e:
        print(f"‚ö†Ô∏è  Full workflow stopped at AI enhancement: {str(e)}")
        print("   Template-based workflow completed successfully")
    
    print("\n" + "=" * 70)
    print("üéØ MADU TRIGONA ENHANCEMENT TEST SUMMARY")
    print("   ‚úÖ Template-based brief generation: SUCCESS")
    print("   ‚úÖ Initial brief validation: PASSED")
    print("   ‚ö†Ô∏è  AI enhancement: Requires valid API key")
    print("   üìÅ Files generated: 2-3 brief variations")
    print("   üé¨ Production ready: Template version available")


def create_mock_enhanced_brief(original_brief):
    """Create a mock enhanced brief to show what AI enhancement would produce."""
    
    enhanced = f"""CINEMATIC MADU AHLAN TRIGONA HONEY COMMERCIAL
Professional Photography Brief - AI Enhanced

EXECUTIVE SUMMARY:
Create a breathtaking, award-winning commercial photograph that captures the essence of Madu Ahlan Trigona's pure, therapeutic honey. This shoot combines cinematic storytelling with product photography excellence, showcasing the brand's connection to Indonesia's pristine rainforest heritage.

CREATIVE VISION:
Transport viewers into an enchanted rainforest where nature's golden treasure reveals itself through dramatic lighting and mystical atmosphere. The honey bottle becomes a precious artifact, blessed by ancient forest wisdom and modern therapeutic science.

{original_brief}

ENHANCED CREATIVE DIRECTION:

EMOTIONAL NARRATIVE:
The image should evoke a sense of discovering hidden treasure in nature's sanctuary. Each element contributes to a story of purity, tradition, and natural healing power that resonates with health-conscious consumers seeking authentic, premium products.

ADVANCED CINEMATOGRAPHY:
- Execute a fluid 360-degree camera movement that reveals the product's majesty from every angle
- Utilize practical lighting effects with the golden hour sun creating natural lens flares
- Employ slow-motion capture techniques for the honey pour sequence
- Integrate particle systems and atmospheric effects for mystical enhancement

CULTURAL AUTHENTICITY:
Honor Indonesian rainforest heritage through respectful environmental representation. The "Alami dan Berkhasiat" messaging should feel organic to the scene, not imposed upon it.

POST-PRODUCTION EXCELLENCE:
Color grade for cinematic warmth with deep forest shadows and brilliant golden highlights. Enhance the magical qualities while maintaining photorealistic integrity throughout the composition.

This brief represents the perfect fusion of commercial photography expertise and creative storytelling, designed to create imagery that sells not just a product, but an experience of natural wellness and cultural heritage.
"""
    
    return enhanced


if __name__ == "__main__":
    asyncio.run(test_madu_trigona_enhancement())
